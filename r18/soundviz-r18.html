<!doctype html>
<html lang=en >
<head>
<title>SoundViz R18</title>
<meta charset=utf-8 />
<meta name=author content='Theo Armour' />
<meta name=viewport content=width=device-width,user-scalable=no,minimum-scale=1.0,maximum-scale=1.0 />
<link rel=stylesheet href=http://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.css />
</head>
<body>
<!--
<script src=http://mrdoob.github.io/three.js/build/three.min.js ></script>
-->
<script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/r69/three.min.js'></script>

<script src=http://mrdoob.github.io/three.js/examples/js/controls/TrackballControls.js ></script>
<script src=http://mrdoob.github.io/three.js/examples/js/libs/stats.min.js ></script>

<script src=ja-core.js></script>
<script src=jath-three.js></script>
<script src=jali-lights.js></script>
<script src=jama-materials.js></script>
<script src=jama-materials-data.js></script>
<script src=sowi-widgets.js></script>
<script src=sosa-online-samples.js></script>
<script src=sofr-file-reader.js></script>
<script src=japr-preferences.js></script>
<script src=soco-controls.js></script>
<script src=soas-assets.js></script>

<script>
	var marker;
	var mouseDown;

	JA.init = function() {
		JA.running = false;
		JA.container = document.body.appendChild( document.createElement( 'div' ) );

		JA.addCSS();

		JA.addHeader();
		JA.addHR();
		JA.addMenu();

		JATH.addThreeJS();
		SOSA.addOnlineSamples();
		SOFR.addFileReader();

		JALI.addLightsBox();
		JAMA.addMaterialSelectTab();
		JAMA.addMaterialEditorTab();
		JAPR.addPreferencesBox();

		SOWI.addAbout();
		SOCO.addControls();
		SOWI.addMessages();

		JA.addThreeFooter();

		SOAS.addAssets();

		window.addEventListener('mouseup', JA.mouseUp, false);
		window.addEventListener('mouseDown', JA.mouseUp, false);
		window.addEventListener( 'resize', JA.onWindowResize, false );
	}

	JA.MouseDown = function( event ) {

		mouseDown = true;

	}

	JA.animate = function() {
		requestAnimationFrame( JA.animate );
		JATH.controls.update();
		
		if ( JA.running ) JA.update();

		if ( !mouseDown ) {
			time = Date.now() * 0.001;
//			time = timestamp;// * 0.001;

			rx = Math.sin( time * 0.7 ) * 0.5;
				ry = Math.sin( time * 0.3 ) * 0.5;
				rz = Math.sin( time * 0.2 ) * 0.5;

			JATH.camera.position.x += rx;
			JATH.camera.position.x += ry;
			JATH.camera.position.y += rz;

			JATH.camera.lookAt( JATH.scene.position );

		}

		JATH.stats.update();
		JATH.renderer.render( JATH.scene, JATH.camera );
	}

	JA.update = function() {
//		if ( !JA.running ) return;
		//elevations, 
		var vertices, len;
		if ( !SOFR.heights || !SOFR.heights.length ) return;

		if ( SOFR.frame >= SOFR.heights.length ) {
			var nowTime = new Date();
			divMsg.innerHTML = 'Time in ms: ' + ( nowTime - SOFR.startTime );
			SOFR.startTime = nowTime;
			SOFR.frame = 0;
		}

		var vertices = mesh.geometry.vertices;
		var elevations = SOFR.heights[ SOFR.frame ];
		var len = elevations.length;

		for ( var i = 0; i < len; i++ ) {

			vertices[ i ].y = elevations[ i ];

		}

		geometry.computeFaceNormals();
		geometry.computeVertexNormals();

		mesh.geometry.verticesNeedUpdate = true;  
		mesh.geometry.normalsNeedUpdate = true;

		if ( marker && len === 15876 ) {
			var i = 126 * parseInt( rngYCoordinate.value, 10 ) + parseInt( rngXCoordinate.value, 10 );
			marker.position.set( vertices[ i ].x , mesh.scale.y * elevations[ i ] + JATH.selectedObject.position.y, vertices[ i ].z );
		}

		divRunTime.innerHTML = 'Frame: ' + SOFR.frame;
		SOFR.frame++;
	}

	JA.init();
	JA.animate();

</script>
</body>
</html>